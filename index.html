<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mermaid Graph to Image Generator</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
  </head>
  <body>
    <textarea id="mermaidInput" rows="10" cols="50"></textarea>
    <button onclick="generateGraphImage()">画像生成</button>
    <div id="mermaidGraph"></div>
    <img id="outputImage" style="max-width: 100%" />

    <script>
      mermaid.initialize({ startOnLoad: true })

      async function generateGraphImage() {
        const input = document.getElementById('mermaidInput').value
        const output = document.getElementById('mermaidGraph')
        output.innerHTML = ''

        // SVGとしてグラフを生成
        const { svg } = await mermaid.render('graphDiv', input)
        output.innerHTML = svg

        // SVGをCanvasに描画
        const svgElement = output.querySelector('svg')
        const canvas = await svgToCanvas(svgElement)

        // CanvasからPNG画像を生成
        const dataUrl = canvas.toDataURL('image/png')

        // 画像のダウンロードリンクを作成（オプション）
        const downloadLink = document.createElement('a')
        downloadLink.href = dataUrl
        downloadLink.download = 'mermaid_graph.png'
        downloadLink.textContent = '画像をダウンロード'
        output.appendChild(downloadLink)
      }

      async function svgToCanvas(svgElement) {
        const svgData = new XMLSerializer().serializeToString(svgElement)
        const canvas = document.createElement('canvas')
        const ctx = canvas.getContext('2d')

        return new Promise((resolve) => {
          const img = new Image()
          img.onload = () => {
            canvas.width = img.width
            canvas.height = img.height
            ctx.drawImage(img, 0, 0)
            resolve(canvas)
          }
          img.src =
            'data:image/svg+xml;base64,' +
            btoa(unescape(encodeURIComponent(svgData)))
        })
      }
    </script>
  </body>
</html>
